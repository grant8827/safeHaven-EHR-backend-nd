generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  therapist
  staff
  client
}

enum AppointmentType {
  initial_consultation
  therapy_session
  follow_up
  group_therapy
  telehealth
  assessment
}

enum AppointmentStatus {
  scheduled
  confirmed
  in_progress
  completed
  cancelled
  no_show
  rescheduled
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

enum ClaimStatus {
  draft
  submitted
  pending
  approved
  denied
  paid
}

enum DocumentCategory {
  medical_record
  insurance
  consent_form
  assessment
  treatment_plan
  progress_note
  discharge_summary
  other
}

enum TelehealthStatus {
  scheduled
  waiting_room
  connecting
  active
  on_hold
  ended
  cancelled
  failed
}

// User and Authentication
model User {
  id                 String   @id @default(uuid())
  username           String   @unique
  email              String   @unique
  passwordHash       String
  firstName          String
  lastName           String
  phoneNumber        String?
  role               UserRole @default(client)
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(false)
  lastLogin          DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  refreshTokens      RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  auditLogs          AuditLog[]
  
  patientProfile     Patient?
  assignedPatients   Patient[] @relation("assignedTherapist")
  appointments       Appointment[] @relation("therapist")
  createdAppointments Appointment[] @relation("creator")
  
  sentMessages       Message[] @relation("sender")
  readMessages       Message[] @relation("reader")
  messageThreadParticipants MessageThreadParticipant[] @relation("messageThreadParticipants")
  
  createdInvoices    Invoice[] @relation("creator")
  createdNotes       SOAPNote[]
  sessionParticipants TelehealthParticipant[]

  @@index([role])
  @@index([isActive])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  revokedAt DateTime?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
}

// Patient Management
model Patient {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dateOfBirth         DateTime?
  street              String?
  city                String?
  state               String?
  zipCode             String?
  country             String?
  
  emergencyContactName String?
  emergencyContactRelationship String?
  emergencyContactPhone String?
  emergencyContactEmail String?
  
  insuranceProvider   String?
  insurancePolicyNumber String?
  insuranceGroupNumber String?
  insuranceCopay      Float?
  insuranceDeductible Float?
  
  medicalHistory      String?
  allergies           String?
  
  assignedTherapistId String?
  assignedTherapist   User?    @relation("assignedTherapist", fields: [assignedTherapistId], references: [id], onDelete: SetNull)
  isActive           Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  appointments        Appointment[]
  invoices            Invoice[]
  soapNotes           SOAPNote[]
  documents           Document[]
  sessions            TelehealthSession[] @relation("patient")

  @@index([userId])
  @@index([assignedTherapistId])
}

// Appointments
model Appointment {
  id            String              @id @default(uuid())
  patientId     String
  patient       Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId   String
  therapist     User                @relation("therapist", fields: [therapistId], references: [id], onDelete: Cascade)
  createdById   String
  createdBy     User                @relation("creator", fields: [createdById], references: [id], onDelete: SetNull)
  
  startTime     DateTime
  endTime       DateTime
  type          AppointmentType
  status        AppointmentStatus   @default(scheduled)
  notes         String?
  telehealthLink String?
  location      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  soapNote      SOAPNote?
  invoice       Invoice?
  session       TelehealthSession?

  @@index([patientId])
  @@index([therapistId])
  @@index([startTime])
  @@index([status])
}

// SOAP Notes
model SOAPNote {
  id            String   @id @default(uuid())
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapistId   String
  therapist     User     @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  appointmentId String?  @unique
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  
  date          DateTime
  subjective    String
  objective     String
  assessment    String
  plan          String
  
  signature     String?
  signatureDate DateTime?
  isLocked      Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([patientId])
  @@index([therapistId])
}

// Billing & Invoices
model Invoice {
  id              String        @id @default(uuid())
  patientId       String
  patient         Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointmentId   String?       @unique
  appointment     Appointment?  @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  createdById     String
  createdBy       User          @relation("creator", fields: [createdById], references: [id], onDelete: SetNull)
  
  invoiceNumber   String        @unique
  date            DateTime
  dueDate         DateTime
  subtotal        Float
  tax             Float
  total           Float
  
  status          InvoiceStatus @default(draft)
  paymentDate     DateTime?
  paymentMethod   String?
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items           InvoiceItem[]
  claim           Claim?

  @@index([patientId])
  @@index([status])
}

model InvoiceItem {
  id            String   @id @default(uuid())
  invoiceId     String
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description   String
  cptCode       String?
  quantity      Int
  unitPrice     Float
  total         Float

  @@index([invoiceId])
}

model Claim {
  id                String      @id @default(uuid())
  invoiceId         String      @unique
  invoice           Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  patientId         String
  
  claimNumber       String      @unique
  insuranceProvider String
  submissionDate    DateTime
  status            ClaimStatus @default(draft)
  amount            Float
  approvedAmount    Float?
  denialReason      String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([patientId])
  @@index([status])
}

// Messaging
model MessageThread {
  id            String   @id @default(uuid())
  subject       String
  lastActivity  DateTime @default(now()) @updatedAt
  isArchived    Boolean  @default(false)
  createdAt     DateTime @default(now())

  messages      Message[]
  participants  MessageThreadParticipant[]

  @@index([isArchived])
  @@index([lastActivity])
}

model MessageThreadParticipant {
  id            String   @id @default(uuid())
  threadId      String
  thread        MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation("messageThreadParticipants", fields: [userId], references: [id], onDelete: Cascade)
  joinedAt      DateTime @default(now())

  @@unique([threadId, userId])
  @@index([userId])
  @@index([threadId])
}

model Message {
  id            String   @id @default(uuid())
  threadId      String
  thread        MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  senderId      String
  sender        User     @relation("sender", fields: [senderId], references: [id], onDelete: Cascade)
  
  readerId      String?
  reader        User?    @relation("reader", fields: [readerId], references: [id], onDelete: SetNull)
  
  content       String
  priority      String   @default("normal") // low, normal, high, urgent
  
  isRead        Boolean  @default(false)
  isEncrypted   Boolean  @default(false)
  
  sentAt        DateTime @default(now())
  readAt        DateTime?
  createdAt     DateTime @default(now())

  attachments   MessageAttachment[]

  @@index([threadId])
  @@index([senderId])
  @@index([isRead])
}

model MessageAttachment {
  id            String   @id @default(uuid())
  messageId     String
  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  fileName      String
  fileSize      Int
  mimeType      String
  isEncrypted   Boolean  @default(false)
  uploadedAt    DateTime @default(now())

  @@index([messageId])
}

// Documents
model Document {
  id            String            @id @default(uuid())
  patientId     String
  patient       Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  title         String
  description   String?
  category      DocumentCategory
  tags          String[]
  
  fileUrl       String?
  fileName      String?
  fileSize      Int?
  mimeType      String?
  
  isEncrypted   Boolean @default(false)
  signature     String?
  signatureDate DateTime?
  isSigned      Boolean @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shares        DocumentShare[]
  accessHistory DocumentAccessLog[]

  @@index([patientId])
  @@index([category])
}

model DocumentShare {
  id            String   @id @default(uuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  recipientEmail String
  shareType     String   // view, edit, comment
  expiresAt     DateTime?
  message       String?
  
  createdAt     DateTime @default(now())

  @@index([documentId])
}

model DocumentAccessLog {
  id            String   @id @default(uuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  accessedAt    DateTime @default(now())
  action        String   // viewed, downloaded, printed, shared

  @@index([documentId])
}

// Telehealth
model TelehealthSession {
  id                String            @id @default(uuid())
  appointmentId     String?           @unique
  appointment       Appointment?      @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  
  patientId         String
  patient           Patient           @relation("patient", fields: [patientId], references: [id], onDelete: Cascade)
  
  roomId            String            @unique
  sessionUrl        String
  status            TelehealthStatus  @default(scheduled)
  
  startedAt         DateTime?
  endedAt           DateTime?
  scheduledDuration Int               // minutes
  actualDuration    Int?              // minutes
  
  platform          String @default("webrtc") // webrtc, zoom, teams, google_meet
  
  recordingEnabled  Boolean @default(true)
  recordingUrl      String?
  recordingSize     Int?
  recordingDuration Int?
  
  chatEnabled       Boolean @default(true)
  screenShareEnabled Boolean @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  participants      TelehealthParticipant[]
  recordings        RecordingMetadata[]
  transcripts       Transcript[]

  @@index([patientId])
  @@index([status])
  @@index([startedAt])
}

model TelehealthParticipant {
  id            String   @id @default(uuid())
  sessionId     String
  session       TelehealthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role          String   // host, therapist, patient, observer
  status        String   @default("waiting") // invited, waiting, connected, disconnected, left
  
  joinedAt      DateTime?
  leftAt        DateTime?
  connectionQuality String? // excellent, good, fair, poor, failed
  
  cameraEnabled Boolean @default(true)
  micEnabled    Boolean @default(true)
  screenSharing Boolean @default(false)
  
  createdAt     DateTime @default(now())

  @@index([sessionId])
  @@index([userId])
}

model RecordingMetadata {
  id            String   @id @default(uuid())
  sessionId     String
  session       TelehealthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  fileName      String
  fileSize      Int
  duration      Int      // seconds
  mimeType      String
  downloadUrl   String?
  
  createdAt     DateTime @default(now())

  @@index([sessionId])
}

model Transcript {
  id            String   @id @default(uuid())
  sessionId     String
  session       TelehealthSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  content       String
  isEncrypted   Boolean @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sessionId])
}

// Audit Logging
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String
  resource   String
  resourceId String
  oldValues  Json?
  newValues  Json?
  ipAddress  String
  userAgent  String
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([userId])
}
